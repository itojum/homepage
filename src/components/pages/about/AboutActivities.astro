---
import TimelineItem from "./TimelineItem.astro";
import { getActivities } from "@/libs/microcms";
import type { Activity as MicroCMSActivity } from "@/types/activity";

type TimelineItemType = "project" | "event" | "work" | "examination" | "other" | "current";

interface Activity {
	title: string;
	date: Date;
	type: TimelineItemType;
	link:
		| {
				url: string;
				text: string;
		  }
		| undefined;
}

// microCMSからアクティビティを取得
const microCMSActivities = await getActivities({
	orders: "-date",
});

// microCMSのデータを内部形式に変換
const activities: Activity[] = microCMSActivities.map((item: MicroCMSActivity) => {
	const type = (item.type[0] || "other") as TimelineItemType;

	return {
		title: item.title,
		date: new Date(item.date),
		type: type,
		link:
			item.link && item.link_text
				? {
						url: item.link,
						text: item.link_text,
					}
				: undefined,
	};
});

const sortedActivities = [...activities].sort((a, b) => b.date.getTime() - a.date.getTime());

const nowItem: Activity = {
	title: "現在",
	date: new Date(),
	type: "current",
	link: undefined,
};

const timelineItems = [nowItem, ...sortedActivities];
---

<h2>Activities</h2>
<div class="activities-timeline">
  <ul class="activities-timeline__list">
    <span
      class="activities-timeline__line"
      aria-hidden="true"></span>
    {
      timelineItems.map((activity, index) => (
        <TimelineItem activity={activity} isFirst={index === 0} />
      ))
    }
  </ul>
</div>

<style>
  .activities-timeline {
    margin-top: 1.5rem;
  }

  .activities-timeline__list {
    position: relative;
    padding-left: 0;
    list-style: none;
  }

  .activities-timeline__line {
    position: absolute;
    left: 0.75rem;
    top: 0.5rem;
    bottom: 0.5rem;
    width: 0.125rem;
    background-color: rgb(var(--timeline-line));
    border-radius: 9999px;
  }
</style>
